<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥—É</title>
  <meta name="color-scheme" content="dark light" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#000; --fg:#fff; --muted:#aaa; --accent:#19A0FF; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #wrap { position:fixed; inset:0; display:flex; flex-direction:column; padding-bottom: calc(env(safe-area-inset-bottom) + 76px); }
    #stage { position:relative; flex:1; display:flex; align-items:center; justify-content:center; background:#000; }
    #video { width:100%; height:100%; object-fit:cover; background:#000; }

    /* ROI guide */
    #guide { position:absolute; width:min(86vw, 560px); aspect-ratio: 1.8/1; border:3px solid rgba(255,255,255,.75); border-radius:14px; box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset; }
    #status { position:absolute; left:50%; transform:translateX(-50%); bottom: calc(env(safe-area-inset-bottom) + 92px); background:rgba(0,0,0,.6); padding:10px 14px; border-radius:12px; font-weight:600; font-size:14px; text-align:center; white-space:nowrap; }

    /* Toolbar pinned to bottom */
    #toolbar { position:fixed; left:0; right:0; bottom:0; padding:10px calc(12px + env(safe-area-inset-right)) calc(12px + env(safe-area-inset-bottom)) calc(12px + env(safe-area-inset-left)); background:rgba(0,0,0,.6); backdrop-filter: blur(6px); display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .btn { flex:1; min-height:48px; border:0; border-radius:14px; font-weight:700; font-size:16px; color:#fff; background:#1e1e1e; padding:12px; }
    .btn:active { transform: scale(.98); }
    .btn.primary { background: var(--accent); }
    .seg { display:flex; gap:8px; flex:2; }
    .pill { min-width:84px; text-align:center; background:#111; padding:8px 10px; border-radius:999px; font-weight:700; }
    select { flex:2; min-height:48px; border-radius:12px; border:1px solid #333; background:#111; color:#fff; padding:8px; }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="stage">
      <video id="video" playsinline></video>
      <div id="guide" aria-hidden="true"></div>
      <div id="status">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è‚Ä¶</div>
    </div>

    <div id="toolbar">
      <button id="btnTorch" class="btn">üí° –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
      <div class="seg">
        <button id="btnPause" class="btn">‚è∏ –ü–∞—É–∑–∞</button>
        <button id="btnResume" class="btn primary" disabled>‚ñ∂ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
      </div>
      <span class="pill">–°–∫–∞–Ω—ñ–≤: <strong id="counter">0</strong></span>
    </div>
  </div>

  <script type="module">
    import {
      BrowserMultiFormatReader,
      NotFoundException,
      DecodeHintType,
      BarcodeFormat
    } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/+esm";

    const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand();

    // --- DOM refs ---
    const video   = document.getElementById('video');
    const status  = document.getElementById('status');
    const btnTorch= document.getElementById('btnTorch');
    const btnPause= document.getElementById('btnPause');
    const btnResume=document.getElementById('btnResume');
    const counter = document.getElementById('counter');

    // --- ZXing reader with strong hints ---
    const hints = new Map();
    hints.set(DecodeHintType.TRY_HARDER, true);
    hints.set(DecodeHintType.POSSIBLE_FORMATS, [
      BarcodeFormat.EAN_13,
      BarcodeFormat.EAN_8,
      BarcodeFormat.UPC_A,
      BarcodeFormat.CODE_128,
      BarcodeFormat.CODE_39,
      BarcodeFormat.ITF,
      BarcodeFormat.QR_CODE,
      BarcodeFormat.DATA_MATRIX,
      BarcodeFormat.PDF_417
    ]);
    const reader = new BrowserMultiFormatReader(hints);

    let streamTrack = null;
    let scanningPaused = false;
    let lastText = null;
    let lastTime = 0;
    let totalCount = 0;
    const DUP_WINDOW_MS = 1200;   // —ñ–≥–Ω–æ—Ä –æ–¥–Ω–∞–∫–æ–≤–∏—Ö –∫–∞–¥—Ä—ñ–≤ –≤–ø—Ä–æ–¥–æ–≤–∂ 1.2—Å
    const REARM_MS = 5000;        // —á–µ—Ä–µ–∑ 5—Å —Ç–æ–π —Å–∞–º–∏–π –∫–æ–¥ –∑–Ω–æ–≤—É –ø—Ä–∏–π–º–∞—î–º–æ

    function setStatus(t) { status.textContent = t; }
    function bumpCounter(){ counter.textContent = String(++totalCount) }

    async function setTorch(on) {
      try {
        if (!streamTrack) return false;
        const caps = streamTrack.getCapabilities?.();
        if (!caps?.torch) return false;
        await streamTrack.applyConstraints({ advanced: [{ torch: !!on }] });
        return true;
      } catch { return false; }
    }

    btnTorch.addEventListener('click', async () => {
      if (!streamTrack) return tg?.showAlert('–ö–∞–º–µ—Ä–∞ —â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞');
      const cur = streamTrack.getConstraints?.().advanced?.some(c => c.torch);
      const ok = await setTorch(!cur);
      if (!ok) tg?.showAlert('–õ—ñ—Ö—Ç–∞—Ä–∏–∫ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
    });

    btnPause.addEventListener('click', () => { scanningPaused = true; btnPause.disabled=true; btnResume.disabled=false; setStatus('‚è∏ –ü–∞—É–∑a'); });
    btnResume.addEventListener('click', () => { scanningPaused = false; btnPause.disabled=false; btnResume.disabled=true; setStatus('‚ñ∂ –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è...'); });

    async function start() {
      try {
        // –±—ñ–ª—å—à ¬´–≤–∏–±–∞–≥–ª–∏–≤—ñ¬ª constraints –¥–ª—è –∫—Ä–∞—â–æ—ó –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ
        const constraints = {
          audio: false,
          video: {
            facingMode: { ideal: 'environment' },
            width:  { ideal: 1280 },
            height: { ideal: 720 },
            focusMode: 'continuous'
          }
        };

        await reader.decodeFromConstraints(constraints, video, (result, err, controls) => {
          if (!streamTrack && video.srcObject) {
            const tracks = video.srcObject.getVideoTracks();
            if (tracks && tracks[0]) streamTrack = tracks[0];
          }

          if (scanningPaused) return;

          if (result) {
            const text = result.getText();
            const format = result.getBarcodeFormat();
            const now = Date.now();

            // –∞–Ω—Ç–∏‚Äë–¥—É–±–ª—å: —Ç–æ–π —Å–∞–º–∏–π —Ç–µ–∫—Å—Ç –≤–ø—Ä–æ–¥–æ–≤–∂ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –≤—ñ–∫–Ω–∞ —ñ–≥–Ω–æ—Ä—É—î–º–æ
            const isSame = (text === lastText);
            const withinDup = (now - lastTime) < DUP_WINDOW_MS;
            const allowAgain = (now - lastTime) > REARM_MS;

            if (!isSame || (isSame && !withinDup) || (isSame && allowAgain)) {
              lastText = text; lastTime = now;
              setStatus(`‚úÖ ${text} (${format})`);
              bumpCounter();
              // –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤ –±–æ—Ç
              try { tg?.sendData(JSON.stringify({ format, text, ts: now })); } catch {}
            }
          } else if (err && !(err instanceof NotFoundException)) {
            // —ñ–Ω—à—ñ –ø–æ–º–∏–ª–∫–∏ –∫–∞–º–µ—Ä–∏/–¥–µ–∫–æ–¥–µ—Ä–∞
            console.warn(err);
          }
        });

        setStatus('‚ñ∂ –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è... –ù–∞–≤–µ–¥—ñ—Ç—å —Ä–∞–º–∫—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥/QR');
      } catch (e) {
        setStatus('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏: ' + e);
      }
    }

    start();
  </script>
</body>
</html>
