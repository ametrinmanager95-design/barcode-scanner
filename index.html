<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>Сканер штрихкодів</title>
  <style>
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:#0d0f14;color:#fff}
    .wrap{display:flex;flex-direction:column;min-height:100vh}
    header{padding:12px 16px;background:#111826;border-bottom:1px solid #222}
    h1{font-size:16px;margin:0}
    .view{position:relative;flex:1;display:flex;align-items:center;justify-content:center}
    video{width:100%;height:100%;object-fit:cover}
    .mask{position:absolute;inset:0;box-shadow:inset 0 0 0 9999px rgba(0,0,0,.4),
          inset 0 0 0 2px rgba(255,255,255,.4);border-radius:16px;margin:24px}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
           background:#16a34a;padding:10px 14px;border-radius:10px;display:none}
    .actions{position:fixed;top:12px;right:12px;display:flex;gap:8px}
    button{appearance:none;border:1px solid #2a2f3a;background:#151a22;color:#fff;
           padding:8px 10px;border-radius:10px;font-size:14px}
    button:active{transform:scale(0.98)}
  </style>
</head>
<body>
<div class="wrap">
  <header><h1>Скануйте штрихкод…</h1></header>
  <div class="view">
    <video id="video" playsinline muted></video>
    <div class="mask"></div>
  </div>
  <div class="actions">
    <button id="torchBtn" disabled>Ліхтар</button>
    <button id="flipBtn">Камера</button>
  </div>
  <div class="toast" id="toast">Відправлено</div>
</div>

<script src="https://unpkg.com/@zxing/library@0.21.3"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  const codeReader = new ZXing.BrowserMultiFormatReader();
  const video = document.getElementById('video');
  const toast = document.getElementById('toast');
  const torchBtn = document.getElementById('torchBtn');
  const flipBtn = document.getElementById('flipBtn');

  let currentDeviceId = null;
  let streamTrack = null;
  let torchOn = false;
  let busy = false;

  async function start(cameraId=null){
    try{
      const constraints = {
        audio: false,
        video: cameraId ? {deviceId: {exact: cameraId}} : {facingMode: {ideal: "environment"}}
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      streamTrack = stream.getVideoTracks()[0];

      const cap = streamTrack.getCapabilities?.() || {};
      torchBtn.disabled = !(cap.torch);
      if (!torchBtn.disabled) torchBtn.textContent = "Ліхтар: викл";

      detectLoop();
    }catch(e){
      alert("Доступ до камери не надано або камера недоступна.");
      console.error(e);
    }
  }

  async function detectLoop(){
    try{
      const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'video');
      if (result && result.text && !busy){
        busy = true;
        const code = result.text.trim();
        if (tg){
          tg.sendData(code);
        }
        showToast("Відправлено: " + truncate(code, 40));
        setTimeout(()=> busy=false, 1200);
      }
    }catch(e){
      if (!busy) requestAnimationFrame(detectLoop);
    }
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display='none', 1200);
  }

  function truncate(s, n){ return s.length>n ? s.slice(0,n-1)+'…' : s; }

  torchBtn.addEventListener('click', async ()=>{
    if (!streamTrack) return;
    const cap = streamTrack.getCapabilities?.() || {};
    if (!cap.torch) return;
    torchOn = !torchOn;
    await streamTrack.applyConstraints({advanced: [{torch: torchOn}]});
    torchBtn.textContent = "Ліхтар: " + (torchOn ? "вкл" : "викл");
  });

  flipBtn.addEventListener('click', async ()=>{
    const devices = await codeReader.listVideoInputDevices();
    if (!devices.length) return;
    const idx = devices.findIndex(d => d.deviceId === currentDeviceId);
    const next = devices[(idx+1) % devices.length];
    currentDeviceId = next.deviceId;
    if (video.srcObject){
      video.srcObject.getTracks().forEach(t=>t.stop());
    }
    await start(currentDeviceId);
  });

  (async ()=>{
    const devices = await codeReader.listVideoInputDevices();
    if (devices.length){
      currentDeviceId = devices[0].deviceId;
    }
    await start(currentDeviceId);
  })();
</script>
</body>
</html>
