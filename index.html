<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>EAN-13 Scanner ‚Äî Strict</title>
  <meta name="color-scheme" content="dark light" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#000; --fg:#fff; --accent:#19A0FF; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #wrap { position:fixed; inset:0; display:flex; flex-direction:column; }
    #stage { position:relative; flex:1; background:#000; }
    #video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    #guide { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(92vw,720px); height:min(22vh,180px); border:3px solid rgba(255,255,255,.9); border-radius:12px; box-shadow:0 0 0 9999px rgba(0,0,0,.5) inset; }
    #status { position:absolute; left:50%; transform:translateX(-50%); bottom:20px; background:rgba(0,0,0,.6); padding:10px 14px; border-radius:12px; font-weight:700; font-size:14px; }
    #toolbar { display:flex; gap:10px; padding:10px; background:rgba(0,0,0,.6); backdrop-filter: blur(6px); }
    .btn { flex:1; min-height:48px; border:0; border-radius:14px; font-weight:700; font-size:16px; color:#fff; background:#1e1e1e; padding:12px; }
    .btn.primary { background: var(--accent); }
    .pill { background:#111; padding:8px 12px; border-radius:999px; }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="stage">
      <video id="video" playsinline></video>
      <div id="guide"></div>
      <div id="status">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è‚Ä¶</div>
    </div>
    <div id="toolbar">
      <button id="btnTorch" class="btn">üí° –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
      <span class="pill">–°–∫–∞–Ω—ñ–≤: <strong id="counter">0</strong></span>
      <button id="btnClose" class="btn">‚úñ –ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader, DecodeHintType, BarcodeFormat, NotFoundException } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/+esm";

    const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand();

    const video   = document.getElementById('video');
    const guide   = document.getElementById('guide');
    const status  = document.getElementById('status');
    const counter = document.getElementById('counter');
    const btnTorch= document.getElementById('btnTorch');
    const btnClose= document.getElementById('btnClose');

    let track = null; let total = 0; let last = ''; let lastAt = 0;

    function setStatus(t){ status.textContent = t; }
    function bump(){ counter.textContent = String(++total); }

    async function startCam(){
      const constraints = {
        audio:false,
        video:{ facingMode:{ ideal:'environment' }, width:{ ideal:1920 }, height:{ ideal:1080 }, focusMode:'continuous' }
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream; await video.play();
      track = stream.getVideoTracks()[0];
    }

    async function setTorch(on){
      try{ const caps = track?.getCapabilities?.(); if(!caps?.torch) return false; await track.applyConstraints({ advanced:[{ torch: !!on }] }); return true; }catch{ return false; }
    }

    btnTorch.addEventListener('click', async ()=>{ const cur = track?.getConstraints?.().advanced?.some(a=>a.torch); const ok = await setTorch(!cur); if(!ok) tg?.showAlert('–õ—ñ—Ö—Ç–∞—Ä–∏–∫ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è'); });
    btnClose.addEventListener('click', ()=> tg?.close());

    // ZXing —ñ–∑ –∂–æ—Ä—Å—Ç–∫–∏–º–∏ –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏ –ø—ñ–¥ EAN-13
    const hints = new Map();
    hints.set(DecodeHintType.TRY_HARDER, true);
    hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.EAN_13]);
    // hints.set(DecodeHintType.ASSUME_GS1, true); // —Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ, —è–∫—â–æ –∫–æ–¥–∏ GS1
    const reader = new BrowserMultiFormatReader(hints);

    function getRoi(){
      const vw = video.videoWidth, vh = video.videoHeight; if(!vw||!vh) return null;
      const guideRect = guide.getBoundingClientRect();
      const videoRect = video.getBoundingClientRect();
      const rx = vw / videoRect.width, ry = vh / videoRect.height;
      const x = Math.max(0, (guideRect.left - videoRect.left) * rx);
      const y = Math.max(0, (guideRect.top  - videoRect.top ) * ry);
      const w = Math.min(vw - x, guideRect.width  * rx);
      const h = Math.min(vh - y, guideRect.height * ry);
      return { x, y, width:w, height:h };
    }

    // –û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª: decodeFromConstraints —ñ–∑ callback –ø—Ä–∞—Ü—é—î —à–≤–∏–¥—à–µ –∑–∞ –∑–π–æ–º–∫—É canvas, –∞–ª–µ
    // –¥–ª—è –∂–æ—Ä—Å—Ç–∫–æ–≥–æ ROI –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –ø—Ä–æ–º—ñ–∂–Ω–∏–π canvas —ñ decodeOnce –Ω–∞ –≤–∏—Ä—ñ–∑—Ü—ñ (–¥–∞—î –ø—Ä–∏—Ä—ñ—Å—Ç –Ω–∞ –¥—Ä—ñ–±–Ω–∏—Ö –∫–æ–¥–∞—Ö)
    async function loopZXing(){
      const cv = document.createElement('canvas');
      const ctx = cv.getContext('2d', { willReadFrequently:true });
      async function tick(){
        if(video.readyState >= 2){
          const roi = getRoi();
          if(roi){
            const tw = Math.min(roi.width, 1280); // –æ–±–º–µ–∂—É—î–º–æ –¥–æ ~HD –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ
            const th = Math.max(1, Math.round(roi.height * (tw/roi.width)));
            cv.width = tw; cv.height = th;
            ctx.drawImage(video, roi.x, roi.y, roi.width, roi.height, 0, 0, tw, th);
            try{
              const result = await reader.decodeFromImage(cv);
              if(result){
                const text = result.getText(); const format = result.getBarcodeFormat();
                const now = Date.now();
                if(text && (text !== last || now - lastAt > 1200)){
                  last = text; lastAt = now; setStatus(`‚úÖ ${text} (${format})`); bump();
                  try{ tg?.sendData(JSON.stringify({ format, text, ts: now })); }catch{}
                }
              }
            }catch(e){ if(!(e instanceof NotFoundException)) console.warn(e); }
          }
        }
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    async function start(){
      try{ await startCam(); }catch(e){ setStatus('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏: '+e); return; }
      setStatus('‚ñ∂ –ù–∞–≤–µ–¥—ñ—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥ —É —Ä–∞–º–∫—É (EAN‚Äë13)');
      await loopZXing();
    }

    start();
  </script>
</body>
</html>
