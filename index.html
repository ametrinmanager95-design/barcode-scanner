<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥—É</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    import { BrowserMultiFormatReader, NotFoundException } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/+esm";

    const tg = window.Telegram?.WebApp;
    tg?.ready();
    tg?.expand();

    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const btnTorch = document.getElementById('btnTorch');
    const btnClose = document.getElementById('btnClose');

    const codeReader = new BrowserMultiFormatReader();
    let lastSent = null;
    let streamTrack = null;

    function setStatus(txt) { status.textContent = txt; }

    async function toggleTorch() {
      try {
        if (!streamTrack) return;
        const caps = streamTrack.getCapabilities?.();
        if (!caps || !caps.torch) {
          tg?.showAlert('–õ—ñ—Ö—Ç–∞—Ä–∏–∫ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
          return;
        }
        const constraints = streamTrack.getConstraints?.();
        const enabled = constraints?.advanced?.some(c => c.torch);
        await streamTrack.applyConstraints({ advanced: [{ torch: !enabled }] });
      } catch (e) {
        tg?.showAlert('–ü–æ–º–∏–ª–∫–∞ –ª—ñ—Ö—Ç–∞—Ä–∏–∫–∞: ' + e);
      }
    }

    async function startScan() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        if (cams.length === 0) {
          setStatus('–ö–∞–º–µ—Ä—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
          return;
        }
        const back = cams.find(c => /back|rear|environment/i.test(c.label));
        const deviceId = (back || cams[0]).deviceId;

        await codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
          if (!streamTrack && video.srcObject) {
            const tracks = video.srcObject.getVideoTracks();
            if (tracks && tracks[0]) streamTrack = tracks[0];
          }

          if (result) {
            const text = result.getText();
            const format = result.getBarcodeFormat();
            setStatus('‚úÖ –ó—á–∏—Ç–∞–Ω–æ: ' + text + ' (' + format + ')');
            if (text && text !== lastSent) {
              lastSent = text;
              const payload = { format, text, ts: Date.now() };
              try {
                tg?.sendData(JSON.stringify(payload));
              } catch (e) {
                console.error('sendData error', e);
                tg?.showAlert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —É –±–æ—Ç: ' + e);
              }
            }
          } else if (err && !(err instanceof NotFoundException)) {
            console.warn(err);
          }
        });

        setStatus('–ù–∞–≤–µ–¥i—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥ / QR‚Ä¶');
      } catch (e) {
        setStatus('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏: ' + e);
      }
    }

    btnTorch.addEventListener('click', toggleTorch);
    btnClose.addEventListener('click', () => tg?.close());
    startScan();
  </script>
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Arial; }
    #wrap { display:flex; flex-direction:column; height:100%; background:#000; }
    #video { width:100%; height:auto; background:#000; }
    #toolbar { display:flex; gap:8px; padding:8px; justify-content:center; background:#111; }
    button { padding:10px 14px; border-radius:12px; border:0; font-weight:600; }
    #status { color:#fff; padding:12px; text-align:center; }
  </style>
</head>
<body>
  <div id="wrap">
    <video id="video" playsinline></video>
    <div id="toolbar">
      <button id="btnTorch">üí° –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
      <button id="btnClose">‚úñ –ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    <div id="status">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è‚Ä¶</div>
  </div>
</body>
</html>
